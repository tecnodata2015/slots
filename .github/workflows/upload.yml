name: upload images

on:
  push:
    paths:
      'test/*'

jobs:
  upload:
    runs-on: ubuntu-latest
    steps:
    
    - name: Check out repository code
      uses: actions/checkout@v2
      
    - name: Dump GitHub context
      id: github_context_step
      run: echo '${{ toJSON(github) }}'
    - name: Dump job context
      run: echo '${{ toJSON(job) }}'
    - name: Dump steps context
      run: echo '${{ toJSON(steps) }}'
    - name: Dump runner context
      run: echo '${{ toJSON(runner) }}'
    - name: Dump strategy context
      run: echo '${{ toJSON(strategy) }}'
    - name: Dump matrix context
      run: echo '${{ toJSON(matrix) }}'
      
    - name: Check changed files
      id: diff
      run: |
          # See https://github.community/t/check-pushed-file-changes-with-git-diff-tree-in-github-actions/17220/10
          if [ $GITHUB_BASE_REF ]; then
            # Pull Request
            git fetch origin $GITHUB_BASE_REF --depth=1
            export DIFF=$( git diff --name-only origin/$GITHUB_BASE_REF $GITHUB_SHA )
            echo "Diff between origin/$GITHUB_BASE_REF and $GITHUB_SHA"
          else
            # Push
            git fetch origin ${{ github.event.before }} --depth=1
            export DIFF=$( git diff --name-only ${{ github.event.before }} $GITHUB_SHA )
            echo "Diff between ${{ github.event.before }} and $GITHUB_SHA"
          fi
          echo "$DIFF"
          # Escape newlines (replace \n with %0A)
          echo "::set-output name=diff::$( echo "$DIFF" | sed ':a;N;$!ba;s/\n/%0A/g' )"
      
    - run: |
        files="${{ steps.diff.outputs.diff }}"
        for fullpath in $files; do
          mimetype=$(file -b --mime-type $fullpath)
          if [[ $mimetype =~ "image" ]]; then
             filename="${fullpath##*/}"
             dir="${fullpath:0:${#fullpath} - ${#filename}}"
             base="${filename%.[^.]*}"
             ext="${filename:${#base} + 1}"                 
             convert -resize 140x140\! $fullpath /tmp/$base.png
             ls /tmp
          fi
          echo "Do something with this $fullpath."
        done
